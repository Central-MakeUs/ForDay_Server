name: Deploy To EC2 (Blue-Green via Bastion)

on:
  push:
    branches: [ "main", "release" ]

permissions:
  contents: read

jobs:
  # 1️⃣ BUILD JOB
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Create application-prod.yml
        run: echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./src/main/resources/application.yml

      - name: Build Spring Boot
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
            | docker login --username AWS --password-stdin 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build & Push Docker Image
        run: |
          docker build -t forday .
          docker tag forday:latest 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest
          docker push 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest

  # 2️⃣ DEPLOY JOB
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH (Bastion → Private)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat <<EOF >> ~/.ssh/config
          Host bastion
            HostName ${{ secrets.BASTION_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no

          Host private
            HostName ${{ secrets.EC2_PRIVATE_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ProxyJump bastion
            StrictHostKeyChecking no
          EOF

      - name: Blue-Green Deploy
        run: |
          ssh private << 'EOF'
            set -e

            echo "▶ Detect current upstream from nginx env file"
            if [ -f /etc/nginx/conf.d/service-env.inc ]; then
              # 현재 설정된 변수값을 가져옵니다.
              CURRENT_VAL=$(grep -oP '(?<=set \$service_url ).*(?=;)' /etc/nginx/conf.d/service-env.inc || echo "blue")
            else
              CURRENT_VAL="blue"
            fi

            echo "현재 서비스 상태: $CURRENT_VAL"

            if [ "$CURRENT_VAL" = "blue" ]; then
              TARGET="green"
              TARGET_PORT=8081
            else
              TARGET="blue"
              TARGET_PORT=8080
            fi

            echo "▶ Deploy target: $TARGET (port: $TARGET_PORT)"

            # ECR 로그인 (Private 서버 내에서 실행)
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com
          
            echo "▶ Pulling latest image"
            docker pull 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest

            echo "▶ Stopping old $TARGET container"
            docker stop $TARGET || true
            docker rm $TARGET || true

            echo "▶ Starting new $TARGET container"
            docker run -d \
              --name $TARGET \
              --restart=always \
              -e SPRING_PROFILES_ACTIVE=$TARGET \
              -p $TARGET_PORT:8080 \
              839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest

            echo "▶ Health Check on http://localhost:$TARGET_PORT/health_check"
            HEALTH_OK=false
            for i in {1..20}; do
              if curl -sf http://localhost:$TARGET_PORT/health_check; then
                HEALTH_OK=true
                break
              fi
              echo "Waiting for $TARGET to be ready... ($i/20)"
              sleep 5
            done

            if [ "$HEALTH_OK" != "true" ]; then
              echo "❌ Health check failed. Rolling back..."
              docker logs $TARGET
              exit 1
            fi

            echo "▶ Switching Nginx upstream to $TARGET"
            echo "set \$service_url $TARGET;" | sudo tee /etc/nginx/conf.d/service-env.inc

            if ! sudo nginx -t; then
              echo "❌ Nginx config error! Rolling back to $CURRENT_VAL"
              echo "set \$service_url $CURRENT_VAL;" | sudo tee /etc/nginx/conf.d/service-env.inc
              exit 1
            fi

            sudo nginx -s reload
            echo "✅ Deployment Successful! Switched to $TARGET"
          EOF