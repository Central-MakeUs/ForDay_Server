name: Deploy To EC2 (Blue-Green via SSM)

on:
  push:
    branches: [ "main", "release" ]

permissions:
  contents: read

jobs:
  # 1ï¸âƒ£ BUILD JOB: Spring Boot ë¹Œë“œ ë° ECR í‘¸ì‹œ
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Create application-prod.yml
        run: echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./src/main/resources/application.yml

      - name: Build Spring Boot
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
            | docker login --username AWS --password-stdin 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build & Push Docker Image
        run: |
          docker build -t forday .
          docker tag forday:latest 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest
          docker push 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest

  # 2ï¸âƒ£ DEPLOY JOB: SSM ëª…ë ¹ ëŒ€ê¸° ë° ë¡œê·¸ í™•ì¸ í¬í•¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Blue-Green Deploy via SSM
        run: |
          # 1. ëª…ë ¹ ì „ì†¡ ë° Command ID ì¶”ì¶œ
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --comment "Blue-Green Deployment with Wait and Log Verification" \
            --parameters '{
              "commands": [
                "set -e",
                "ENV_FILE=/etc/nginx/conf.d/service-env.inc",
          
                "echo \"â–¶ 1. ìƒíƒœ ê°ì§€ ì¤‘...\"",
                "if [ ! -f $ENV_FILE ]; then sudo sh -c \"printf '\''set \\$service_url blue;'\'' > $ENV_FILE\"; fi",
          
                "if grep -q \"green\" $ENV_FILE; then",
                "  TARGET=\"blue\"; TARGET_PORT=8080; OLD_TARGET=\"green\";",
                "else",
                "  TARGET=\"green\"; TARGET_PORT=8081; OLD_TARGET=\"blue\";",
                "fi",
                "echo \"í˜„ì¬ ì„œë¹„ìŠ¤: $(cat $ENV_FILE) -> íƒ€ê²Ÿ: $TARGET\"",

                "echo \"â–¶ 2. ì´ë¯¸ì§€ êµì²´ ì¤‘ ($TARGET)...\"",
                "aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com",
                "docker pull 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest",
                "docker stop $TARGET || true",
                "docker rm $TARGET || true",
                "docker run -d --name $TARGET --restart=always -e SPRING_PROFILES_ACTIVE=$TARGET -p $TARGET_PORT:8080 -e SPRING_DATA_REDIS_HOST=172.17.0.1 -e SPRING_DATA_REDIS_PORT=6379 839983937363.dkr.ecr.ap-northeast-2.amazonaws.com/forday:latest",
          
                "echo \"â–¶ 3. í—¬ìŠ¤ ì²´í¬ ì‹œì‘ (í¬íŠ¸: $TARGET_PORT)\"",
                "HEALTH_OK=false",
                "for i in {1..20}; do",
                "  HTTP_CODE=$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:$TARGET_PORT/health_check || echo \"000\")",
                "  if [ \"$HTTP_CODE\" = \"200\" ]; then",
                "    echo \"âœ… Health Check ì„±ê³µ (ì‘ë‹µ: $HTTP_CODE)\"",
                "    HEALTH_OK=true",
                "    break",
                "  fi",
                "  echo \"ëŒ€ê¸° ì¤‘... ($i/20) - ì‘ë‹µ: $HTTP_CODE\"",
                "  sleep 5",
                "done",
          
                "if [ \"$HEALTH_OK\" = \"true\" ]; then",
                "  echo \"â–¶ 4. Nginx íŠ¸ë˜í”½ ìŠ¤ìœ„ì¹­ ($TARGET)\"",
                "  sudo sh -c \"printf '\''set \\$service_url $TARGET;'\'' > $ENV_FILE\"",
                "  echo \"íŒŒì¼ ë³€ê²½ í™•ì¸: $(cat $ENV_FILE)\"",
                "  sudo nginx -t && sudo nginx -s reload",
                "  ",
                "  echo \"â–¶ 5. êµ¬ë²„ì „($OLD_TARGET) ì •ë¦¬\"",
                "  docker stop $OLD_TARGET || true",
                "  docker rm $OLD_TARGET || true",
                "  docker image prune -af",
                "  echo \"âœ… ë°°í¬ ì™„ë£Œ! í˜„ì¬ êµ¬ë™ í™˜ê²½: $TARGET\"",
                "else",
                "  echo \"âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.\"",
                "  docker logs $TARGET | tail -n 20",
                "  exit 1",
                "fi"
              ]
            }' --query "Command.CommandId" --output text)

          echo "âœ… ëª…ë ¹ ì „ì†¡ ì™„ë£Œ (Command ID: $COMMAND_ID)"

          # 2. EC2 ë‚´ë¶€ ì‹¤í–‰ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "â³ EC2 ë‚´ë¶€ ë°°í¬ ì‘ì—… ì§„í–‰ ì¤‘... ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

          # 3. ì‹¤ì œ EC2ì—ì„œ ë°œìƒí•œ ëª¨ë“  ì¶œë ¥(ë¡œê·¸)ì„ í™”ë©´ì— í‘œì‹œ
          echo "ğŸ“‹ EC2 ë°°í¬ ë¡œê·¸ í™•ì¸:"
          aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --details \
            --query "CommandInvocations[0].CommandPlugins[0].Output" \
            --output text